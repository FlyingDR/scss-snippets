@import "units";

$font-files: () !default;

$font-families: (
    default: (Arial, sans-serif),
) !default;

$font-sizes: (
    big: 20px,
    bigger: 16px,
    normal: 14px,
    smaller: 12px,
    small: 10px,
) !default;

$font-file-formats: (
    eot: embedded-opentype,
    woff: woff,
    woff2: woff2,
    ttf: truetype,
    svg: svg,
) !default;

$font-default-formats: (woff, ttf, eot, svg) !default;
$font-default-properties: (
    font-weight: normal,
    font-style: normal,
) !default;

// Get font size by name
//
// @param string $size  Registered font size name
@function font-size($size) {
    $sizes: px, em;
    @if ((type_of($size) == number) and index($sizes, unit($size))) {
        @return v($size);
    } @else if (not map_has_key($font-sizes, $size)) {
        @warn 'Unkown font size: ' + $size;
    }
    @return v(map_get($font-sizes, $size));
}

// Set font-size CSS property with given font size name
//
// @param string $size  Registered font size name
@mixin font-size($size) {
    font-size: font-size($size);
}

// Parse given font string into set of CSS properties and their values
//
// @param list $font  Font values list to parse
// @return map
@function parse-font($font) {
    $weights: normal, bold, bolder, lighter, 100, 200, 300, 400, 500, 600, 700, 800, 900;
    $styles: normal, italic, oblique;
    $whitespace: normal, pre, nowrap, pre-wrap, pre-line;
    $transform: none, capitalize, uppercase, lowercase, full-width;
    $sizes: px, em;
    $added: '';
    $properties: ();
    @each $item in $font {
        $ik: null;
        $iv: $item;
        @if (map_has_key($font-families, $item) and not index($added, font-family)) {
            $ik: font-family;
            $iv: join(map_get($font-families, $item), (), comma);
        } @else if (map_has_key($font-sizes, $item) and not index($added, font-size)) {
            $ik: font-size;
            $iv: v(map_get($font-sizes, $item));
        } @else if ((type_of($item) == number) and index($sizes, unit($item)) and not index($added, font-size)) {
            $ik: font-size;
            $iv: v($item);
        } @else if (index($weights, $item) and not index($added, font-weight)) {
            $ik: font-weight;
        } @else if (index($styles, $item) and not index($added, font-style)) {
            $ik: font-style;
        } @else if ((type_of($item) == color) and not index($added, color)) {
            $ik: color;
        } @else if ((type_of($item) == number) and not ((unit($item) == em) and (abs($item) <= 0.5)) and not index($added, line-height)) {
            $ik: line-height;
        } @else if ((type_of($item) == number and index($sizes, unit($item))) and not index($added, letter-spacing)) {
            $ik: letter-spacing;
        } @else if (index($whitespace, $item) and not index($added, white-space)) {
            $ik: white-space;
        } @else if (index($transform, $item) and not index($added, text-transform)) {
            $ik: text-transform;
        }
        @if ($ik != null) {
            $properties: map_merge($properties, ($ik: $iv));
            $added: append($added, $ik);
        }
    }
    @return $properties;
}

// Generate font CSS properties from given font string
//
// @param list $font          Font values list to parse
// @param list $important     List of font properties that should be marked as important
// @param map $modifications    Map of font properties modifications to apply to given font values
@mixin font($font, $important: '', $modifications: null) {
    $font: parse-font($font);
    @if (type_of($modifications) == map) {
        $font: map_merge($font, $modifications);
    }
    @each $prop, $value in $font {
        @if (index($important, $prop) != null) {
            #{$prop}: $value !important;
        } @else {
            #{$prop}: $value;

        }
    }
}

// Register custom font to use in application
//
// @param string $id                Font Id to use in application
// @param string|list $font-names   List of font family names to use for this font e.g. (Tahoma, Helvetica, Arial, sans-serif)
// @param string $filename          Base file name (without extension) of font file if file is stored locally
// @param map $properties           List of additional font CSS properties to put in @font-face definition, e.g. (font-weight: bold), defaults to $font-default-properties
// @param map $formats              List of file formats for locally stored font file, defaults to $font-default-formats
@mixin register-font($id, $font-names, $filename: null, $properties: null, $formats: null) {
    @if (type_of($font-names) != list) {
        $font-names: ($font-names);
    }
    @if ($properties == null) {
        $properties: $font-default-properties;
    }
    @if ($formats == null) {
        $formats: $font-default-formats;
    }
    $font-families: map_merge($font-families, ($id:$font-names)) !global;
    @if ($filename != null) {
        $font-files: map_merge($font-files, ($filename: (name: nth($font-names, 1), formats: $formats, properties: $properties))) !global;
    }
}

@mixin register-font-size($name, $size: null) {
    $sizes: ();
    @if (type_of($name) == 'map') {
        $sizes: $name;
    } @else {
        $sizes: ($name: $size);
    }
    $font-sizes: map-merge($font-sizes, $sizes) !global;
}

// Render registered font faces definition
@mixin font-files($fonts: $font-files) {
    @each $filename, $info in $font-files {
        $formats: map-get($info, formats);
        @font-face {
            font-family: map-get($info, name);
            @if (index($formats, eot) != null) {
                src: font-url('#{$filename}.eot');
            }
            $sources: ();
            @if (index($formats, eot) != null) {
                $ff: map_get($font-file-formats, eot);
                $sources: append($sources, font-url('#{$filename}.eot?#iefix') format('#{$ff}'));
            }
            @each $extension in $formats {
                @if ($extension != eot) {
                    $ff: map_get($font-file-formats, $extension);
                    $sources: append($sources, font-url('#{$filename}.#{$extension}') format('#{$ff}'));
                }
            }
            src: join($sources, (), comma);
            @each $prop, $value in map_get($info, properties) {
                #{$prop}: $value;
            }
        }
    }
}
