@import "susy";

$responsive-config: () !default;
$responsive-default-mq: null !default;
$responsive-base-font-size: 15px !default;

$responsive-is-initialized: false;
$responsive-current-mq: null;

// Get current media query Id within responsive-each()
//
// @param boolean $fallback     true to fallback to default media query if there is no explicit current media query, false to return null in this case
// @return string|null
@function responsive-current-mq($fallback: true) {
    @if ($responsive-current-mq != null) {
        @return $responsive-current-mq;
    } @else if ($fallback) {
        @return $responsive-default-mq;
    } @else {
        @return null;
    }
}

// Shorthand for responsive-current-mq()
@function r-mq($fallback: true) {
    @return responsive-current-mq($fallback);
}

// Get configuration value from responsive config
//
// @param string $key       Configuration key name, multiple level keys are defined as a/b/c
// @param mixed $default    Default value for given configuration key (can be skipped)
// @param string $mq        Media query Id to get configuration for (can be passed instead of $default)
// @param map $config       Configuration map to get value from
// @return mixed
//noinspection CssInvalidFunction
@function responsive-get($key, $default: null, $mq: null, $config: $responsive-config) {
    @if (not $mq) {
        @if (map-has-key($config, $default)) {
            $mq: $default;
            $default: null;
        } @else {
            $mq: r-mq();
        }
    }
    $full-key: $key;
    $result: $default;
    @if (map-has-key($config, $mq)) {
        $mqcfg: map-get($config, $mq);
        $parts: ();
        @while str-index($key, '/') != null {
            $parts: append($parts, str-slice($key, 1, str-index($key, '/') - 1));
            $key: str-slice($key, str-index($key, '/') + 1);
        }
        $parts: append($parts, $key);
        $error: false;
        @each $p in $parts {
            @if (not $error) {
                @if (type-of($mqcfg) == map) {
                    @if (map-has-key($mqcfg, $p)) {
                        $result: map-get($mqcfg, $p);
                        $mqcfg: map-get($mqcfg, $p);
                    } @else {
                        $error: true;
                    }
                } @else {
                    $error: true;
                }
                @if ($error) {
                    $mqcfg: '___NO_MAP_IN_CONFIG___';
                    @if (($key != parent) and (r-has(parent, $mq, $config)) and (map-has-key($config, r-get(parent, null, $mq, $config)))) {
                        $result: r-get($key, $default, r-get(parent, null, $mq, $config), $config);
                    }
                    @if ($default == null) {
                        @warn "Unavailable configuration path '" + $full-key + "' for media query '" + $mq + "'";
                    }
                    $result: $default;
                }
            }
        }
    } @else {
        @warn "Unknown media query id: " + $mq;
    }
    @return $result;
}

// Shorthand for responsive-get()
@function r-get($key, $default: null, $mq: null, $config: $responsive-config) {
    @return responsive-get($key, $default, $mq, $config);
}

// Test if given configuration key is available in from responsive config
//
// @param string $key       Configuration key name, multiple level keys are defined as a/b/c
// @param string $mq        Media query Id to get configuration for (can be passed instead of $default)
// @param map $config       Configuration map to get value from
// @return boolean
@function responsive-has($key, $mq: null, $config: $responsive-config) {
    $test: '___unavailable_key___';
    @return (r-get($key, $test, $mq, $config) != $test);
}

// Shorthand for responsive-has()
@function r-has($key, $mq: null, $config: $responsive-config) {
    @return responsive-has($key, $mq, $config);
}

// Simplification of iteration over available media queries
//
// @param mixed $layout     true to use default layout from configuration
//                          false to disable layout use
//                          string to either specify configuration key of layout to use or explicit shorthand layout
//                          list or map to define explicit layout
// @param map $config       Configuration map to use
@mixin responsive-each($layout: true, $config: $responsive-config, $if-key: null) {
    @each $mq in map-keys($config) {
        $l: null;
        @if ($layout == true and r-has(layout, null, $config)) {
            $l: r-get(layout, null, null, $config);
        } @else if (type-of($layout) == string) {
            @if (r-has($layout, null, $config)) {
                $l: r-get($layout, null, null, $config);
            } @else {
                $l: $layout;
            }
        } @else if (type-of($layout) == list or type-of($layout) == map) {
            $l: $layout;
        }
        @if (($if-key == null) or (r-has($if-key, $mq, $config))) {
            @if ($responsive-current-mq != null) {
                @if ($responsive-current-mq == $mq) {
                    @content;
                }
            } @else {
                $responsive-current-mq: $mq !global;
                @include susy-breakpoint($mq) {
                    @if ($l) {
                        @include with-layout($l) {
                            @content;
                        }
                    } @else {
                        @content;
                    }
                }
                $responsive-current-mq: null !global;
            }
        }
    }
}

// Shorthand for responsive-each()
@mixin r-each($layout: true, $config: $responsive-config, $if-key: null) {
    @include responsive-each($layout, $config, $if-key) {
        @content;
    }
}

// Shorthand for responsive-each() with mandatory $if-key
@mixin r-each-if($if-key, $layout: true, $config: $responsive-config) {
    @include responsive-each($layout, $config, $if-key) {
        @content;
    }
}

// Initialize $susy and $susy-media based on information from $responsive-config
@mixin responsive-init() {
    @if (not $responsive-is-initialized) {
        @if (length($responsive-config) > 0) {
            @if (not $responsive-default-mq) {
                @warn 'Default media query key is not defined in $responsive-default-mq';
            }
            @if (length($susy-media) == 0) {
                $susy-media: () !global;
                @each $mq in map-keys($responsive-config) {
                    $query: r-get(media-query, $mq, $config: $responsive-config);
                    @if ($query) {
                        $susy-media: map-merge($susy-media, ($mq: $query)) !global;
                    }
                }
            }
            @if (length($susy) == 0) {
                $layout: r-get(layout, $config: $responsive-config);
                @if ($layout != null) {
                    $susy: $layout !global;
                }
            }
        }
        $base-font-size: $responsive-base-font-size !global;
        html, body {
            font-size: $base-font-size;
        }
        @include global-box-sizing();
        $responsive-is-initialized: true !global;
    }
}

@include responsive-init();
